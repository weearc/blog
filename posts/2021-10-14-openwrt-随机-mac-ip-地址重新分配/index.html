<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>openwrt 随机 mac --- ip 地址重新分配 | weearc 的个人博客</title>
<meta name="keywords" content="">
<meta name="description" content="有点狗急跳墙的那个味道，不得已而为之">
<meta name="author" content="weearc">
<link rel="canonical" href="https://blog.weearc.top/posts/2021-10-14-openwrt-%E9%9A%8F%E6%9C%BA-mac-ip-%E5%9C%B0%E5%9D%80%E9%87%8D%E6%96%B0%E5%88%86%E9%85%8D/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.da6b016a47bc2e02ef9b9e17d711ae4d8613e6be0c7d7674384a553be2b8ab9e.css" integrity="sha256-2msBake8LgLvm54X1xGuTYYT5r4MfXZ0OEpVO&#43;K4q54=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://blog.weearc.top/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.weearc.top/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.weearc.top/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.weearc.top/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.weearc.top/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">

<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas>
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
<script type="text/javascript" src="/js/fireworks.js"></script>


<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="openwrt 随机 mac --- ip 地址重新分配" />
<meta property="og:description" content="有点狗急跳墙的那个味道，不得已而为之" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.weearc.top/posts/2021-10-14-openwrt-%E9%9A%8F%E6%9C%BA-mac-ip-%E5%9C%B0%E5%9D%80%E9%87%8D%E6%96%B0%E5%88%86%E9%85%8D/" /><meta property="og:image" content="https://blog.weearc.top/papermod-cover.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-14T10:43:50+00:00" />
<meta property="article:modified_time" content="2021-10-14T10:43:50+00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.weearc.top/papermod-cover.png"/>

<meta name="twitter:title" content="openwrt 随机 mac --- ip 地址重新分配"/>
<meta name="twitter:description" content="有点狗急跳墙的那个味道，不得已而为之"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://blog.weearc.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "openwrt 随机 mac --- ip 地址重新分配",
      "item": "https://blog.weearc.top/posts/2021-10-14-openwrt-%E9%9A%8F%E6%9C%BA-mac-ip-%E5%9C%B0%E5%9D%80%E9%87%8D%E6%96%B0%E5%88%86%E9%85%8D/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "openwrt 随机 mac --- ip 地址重新分配",
  "name": "openwrt 随机 mac --- ip 地址重新分配",
  "description": "有点狗急跳墙的那个味道，不得已而为之",
  "keywords": [
    
  ],
  "articleBody": "通常来讲是没有更换 MAC 的必要，但是偶尔被误伤的时候还是很有用的。\n起因 手里多了一台服务器，目前部署在 IDC 中心，由于忘记某个服务的端口我遍采取了端口扫描的方式来查看暴露的端口进而判断服务位置，但是我校 IDS 系统比较厉害，不仅仅是没有扫到服务顺带着连我的 IP 到服务器的访问也一并切断了，因此我需要更换 IP 才能重新正常访问该服务器。但是由于一般使用硬件 MAC 因此对于 DHCP 服务器不会为我重新分配新的 IP 地址直到我上一个 IP 过期释放掉。然而释放的这个过程最长可达一年（我上一年度内网 IP 均未发生变更）。因此只能通过更换 MAC 使得 DHCP 服务器认为我是新的接入设备并重新分配可用 IP。\n思路 一般来讲我可能会选用 Python 来实现更换 MAC 这个操作，但是受限于路由器本身，使用 Shell 脚本可能是更加经济实惠的选择。\n初步思路是从 /dev/urandom 抓取随机数，取 md5sum 获取 16 进制格式然后再切分插入符号。类似如下形式：\n1 echo `dd if=/dev/urandom bs=1 count=32 2\u003e/dev/null | md5sum | cut -b 1-12 | sed 's/\\(..\\)/\\1:/g; s/.$//'` 1 2 # result '21:29:25:69:ec:ad' 但是正如这条 stackoverflow 的讨论串所描述的那样，这样生成的 MAC 地址有概率无法使用，即最直观的感受是要求前两位地址必须为偶数。说白了，由于单播地址限制，首位地址为0x21时相当于映射到多播，但是由于单个硬件设备作为节点连接到网络时其使用单播方法，因此必须限制首位为偶数。即：\n如果第一个八位字节的 LSB 为 0，则它是单播地址。如果第一个八位字节的第二个 LSB 是 1，则它是本地生成的 MAC 地址。\n对应关系如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 0x0 0000 0x1 0001 0x2 0010 0x3 0011 0x4 0100 0x5 0101 0x6 0110 0x7 0111 0x8 1000 0x9 1001 0xA 1010 0xB 1011 0xC 1100 0xD 1101 0xE 1110 0xF 1111 解决方案 因此最直接且最简单的解决方案就是直接针对不合法的地址，也就是所谓奇数进行替换，比如下面这个例子：\n1 echo `dd if=/dev/urandom bs=1 count=32 2\u003e/dev/null | md5sum | cut -b 1-12 | sed 's/\\(..\\)/\\1:/g; s/.$//'|sed 's/^\\(.\\)[13579bdf]/\\10/'` 直接简单粗暴的将不合法的地址全部替换为0。简单省事。不过也存在一个问题，也就是一定程度上减少了随机性。这个时候最佳处理方法大概还是通过awk 来实现。\n",
  "wordCount" : "150",
  "inLanguage": "zh",
  "datePublished": "2021-10-14T10:43:50Z",
  "dateModified": "2021-10-14T10:43:50Z",
  "author":{
    "@type": "Person",
    "name": "weearc"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.weearc.top/posts/2021-10-14-openwrt-%E9%9A%8F%E6%9C%BA-mac-ip-%E5%9C%B0%E5%9D%80%E9%87%8D%E6%96%B0%E5%88%86%E9%85%8D/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "weearc 的个人博客",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.weearc.top/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.weearc.top" accesskey="h" title="weearc 的个人博客 (Alt + H)">weearc 的个人博客</a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.weearc.top/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="https://blog.weearc.top/archives" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://blog.weearc.top/search/" title="检索">
                    <span>检索</span>
                </a>
            </li>
            <li>
                <a href="https://blog.weearc.top/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://blog.weearc.top/about/" title="关于我">
                    <span>关于我</span>
                </a>
            </li>
            <li>
                <a href="https://blog.weearc.top/frlink/" title="友链">
                    <span>友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main beforeScrollMaster" id="list-layout">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.weearc.top">主页</a>&nbsp;»&nbsp;<a href="https://blog.weearc.top/posts/">Posts</a></div>
    <h1 class="post-title">
      openwrt 随机 mac --- ip 地址重新分配
    </h1>
    <div class="post-description">
      有点狗急跳墙的那个味道，不得已而为之
    </div>
    <div class="post-meta"><span title='2021-10-14 10:43:50 +0000 UTC'>十月 14, 2021</span>&nbsp;·&nbsp;1 分钟&nbsp;·&nbsp;weearc

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e8%b5%b7%e5%9b%a0" aria-label="起因">起因</a></li>
                <li>
                    <a href="#%e6%80%9d%e8%b7%af" aria-label="思路">思路</a></li>
                <li>
                    <a href="#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88" aria-label="解决方案">解决方案</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>通常来讲是没有更换 MAC 的必要，但是偶尔被误伤的时候还是很有用的。</p>
<h2 id="起因">起因<a hidden class="anchor" aria-hidden="true" href="#起因">#</a></h2>
<p>手里多了一台服务器，目前部署在 IDC 中心，由于忘记某个服务的端口我遍采取了端口扫描的方式来查看暴露的端口进而判断服务位置，但是我校 IDS 系统比较厉害，不仅仅是没有扫到服务顺带着连我的 IP 到服务器的访问也一并切断了，因此我需要更换 IP 才能重新正常访问该服务器。但是由于一般使用硬件 MAC 因此对于 DHCP 服务器不会为我重新分配新的 IP 地址直到我上一个 IP 过期释放掉。然而释放的这个过程最长可达一年（我上一年度内网 IP 均未发生变更）。因此只能通过更换 MAC 使得 DHCP 服务器认为我是新的接入设备并重新分配可用 IP。</p>
<h2 id="思路">思路<a hidden class="anchor" aria-hidden="true" href="#思路">#</a></h2>
<p>一般来讲我可能会选用 Python 来实现更换 MAC 这个操作，但是受限于路由器本身，使用 Shell 脚本可能是更加经济实惠的选择。</p>
<p>初步思路是从 <code>/dev/urandom</code> 抓取随机数，取 <code>md5sum</code> 获取 16 进制格式然后再切分插入符号。类似如下形式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="sb">`</span>dd <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">bs</span><span class="o">=</span><span class="m">1</span> <span class="nv">count</span><span class="o">=</span><span class="m">32</span> 2&gt;/dev/null <span class="p">|</span> md5sum <span class="p">|</span> cut -b 1-12 <span class="p">|</span> sed <span class="s1">&#39;s/\(..\)/\1:/g; s/.$//&#39;</span><span class="sb">`</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># result</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;21:29:25:69:ec:ad&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是正如<a href="https://stackoverflow.com/questions/42660218/bash-generate-random-mac-address-unicast">这条 stackoverflow 的讨论串</a>所描述的那样，这样生成的 MAC 地址有概率无法使用，即最直观的感受是要求前两位地址必须为偶数。说白了，由于单播地址限制，首位地址为<code>0x21</code>时相当于映射到多播，但是由于单个硬件设备作为节点连接到网络时其使用单播方法，因此必须限制首位为偶数。即：</p>
<blockquote>
<p>如果第一个八位字节的 LSB 为 0，则它是单播地址。如果第一个八位字节的第二个 LSB 是 1，则它是本地生成的 MAC 地址。</p>
</blockquote>
<p>对应关系如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">0x0     0000
</span></span><span class="line"><span class="cl">0x1     0001
</span></span><span class="line"><span class="cl">0x2     0010
</span></span><span class="line"><span class="cl">0x3     0011
</span></span><span class="line"><span class="cl">0x4     0100
</span></span><span class="line"><span class="cl">0x5     0101
</span></span><span class="line"><span class="cl">0x6     0110
</span></span><span class="line"><span class="cl">0x7     0111
</span></span><span class="line"><span class="cl">0x8     1000
</span></span><span class="line"><span class="cl">0x9     1001
</span></span><span class="line"><span class="cl">0xA     1010
</span></span><span class="line"><span class="cl">0xB     1011
</span></span><span class="line"><span class="cl">0xC     1100
</span></span><span class="line"><span class="cl">0xD     1101
</span></span><span class="line"><span class="cl">0xE     1110
</span></span><span class="line"><span class="cl">0xF     1111
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="解决方案">解决方案<a hidden class="anchor" aria-hidden="true" href="#解决方案">#</a></h2>
<p>因此最直接且最简单的解决方案就是直接针对不合法的地址，也就是所谓<code>奇数</code>进行替换，比如下面这个例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="sb">`</span>dd <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">bs</span><span class="o">=</span><span class="m">1</span> <span class="nv">count</span><span class="o">=</span><span class="m">32</span> 2&gt;/dev/null <span class="p">|</span> md5sum <span class="p">|</span> cut -b 1-12 <span class="p">|</span> sed <span class="s1">&#39;s/\(..\)/\1:/g; s/.$//&#39;</span><span class="p">|</span>sed <span class="s1">&#39;s/^\(.\)[13579bdf]/\10/&#39;</span><span class="sb">`</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>直接简单粗暴的将不合法的地址全部替换为0。简单省事。不过也存在一个问题，也就是一定程度上减少了随机性。这个时候最佳处理方法大概还是通过<code>awk</code> 来实现。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://blog.weearc.top/4169015263/">
    <span class="title">« 上一页</span>
    <br>
    <span>在Archlinux上启用外接设备唤醒</span>
  </a>
  <a class="next" href="https://blog.weearc.top/posts/2021-09-11-%E9%80%9A%E8%BF%87-github-actions-%E9%83%A8%E7%BD%B2%E5%8D%9A%E5%AE%A2-%E8%85%BE%E8%AE%AF%E4%BA%91-cloudbase-%E8%B8%A9%E5%9D%912/">
    <span class="title">下一页 »</span>
    <br>
    <span>通过 GITHUB Actions 部署博客---腾讯云 Cloudbase 踩坑2</span>
  </a>
</nav>

  </footer><script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<div id="vcomments"></div>
<script>
    function loadComments() {
        
        new Valine({
            el: '#vcomments',
            appId: 'bhQyg8BFhAianSbFIDztqY5F-gzGzoHsz',
            appKey: 'hyBnHdPlTNOtclNbq8oB5bwg',
            placeholder: 'Just so so',
            notify: 'true',
            verify: 'true',
            path: 'window.location.pathname',
            avatar: '',
            meta: '',
            pageSize: '',
            lang: '',
            visitor: '',
            highlight: '',
            avatarForce: '',
            recordIP: ''
        });
    }
    if (window.location.pathname !== '/about/') {
        loadComments()
    }
</script>
</article>
    </main>
    
<footer class="footer">
    <span>Copyright &copy; 2023 | <a href="https://blog.weearc.top">weearc 的个人博客</a></span></br>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> & theme based on
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span></br>
    <span>
        <a href="http://beian.miit.gov.cn/" rel="noopener" target="_blank" style="border:none;">
            辽ICP备2020011073号
        </a>
    </span>
    </br>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span>
    <span id="busuanzi_container_site_uv"> 本站访客数 <span id="busuanzi_value_site_uv"></span> 人次 </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>
<script type="text/javascript" src="/js/custom.js"></script>
</html>

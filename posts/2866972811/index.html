<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>记一次失败的从 Arch Linux 迁移到 Debian Sid 的经历 | weearc 的个人博客</title>
<meta name="keywords" content="archlinux, 系统迁移, debian, btrfs, 系统备份">
<meta name="description" content="其实我从来没想好自己应该使用什么发行版，十多年前最开始使用 Arch Linux 也只是因为觉得大家都在使用 什么 Ubuntu 啊觉得自己可以特例独行一些，并没有深刻的体会到什么叫做 KISS，也没有体会到各种拆包粒度对于使用的影响，也一直只是“会用”而已，并没有太多作为用户之外的使用体验差距。就算是第二个使用的发行版是 openSUSE 也一样，因为某种程度上有类似的基因。
起因 闲的蛋痛。年初企图迁移到 Fedora 失败，仅仅过了5个小时就滚回了 Arch 。可能考虑到了 Debian Sid 的如下特性，打算这次外迁一定要迁移出去，去 Debian。
足够稳定 apt 的前端 nala，看上去很帅 周围用 Arch 的很多，向特立独行一点 复习时间之余闲的蛋痛 但是也考虑到一些区别，比如：
包管理器的整合性：debian 系素以混乱的包管理功能著称，dpkg、apt、apt-get、apt-file 软件包获取的难度：这也是为什么我一直非常抗拒使用 deb 系，你可以在软件官网上（比如 zotero），在 github release，在 makedeb ，在 pacstall，在 ppa&hellip;你能找出一百个不同的软件包来源，但是你没办法把他们整合（Debian CN repo 许久未变更了） 不知道的一些奇奇怪怪的特性 wiki，debian wiki 也就将将是能参考的程度 以上这些问题并没罗列全面，但是我曾经认为自己能够克服这些问题。虽然显然还是太高看自己了。
Arch Linux -&gt; Debian 安装一个新的发行版是容易的，也没什么好说。但是考虑到年初 fedora 的惨痛经历，我打算还是给自己留个后路，方法可以有很多，rsync、或者整体dd、或者打个 tarball 什么的，之前有过尝试用 squashfs 备份系统的经验，而且打包后镜像体积特别小，也是很多发行版安装 CD 的首选方案。那就决定了。
首先备份根分区，需要排除掉所有额外挂载的分区和运行态的玩意儿：
1 sudo mksquashfs / backup-archlinux.squashfs -e /home -e /run -e /proc -e /dev -e /sys -e /tmp -e /var/tmp -e /mnt /boot/efi 直接把镜像扔到了外挂的 SSD 上面，体积也不大，150 G 根分区体积也就 27 G。然后下载了 Debian stable bookworm 的镜像，写盘，分区，安装&hellip;不一而足。">
<meta name="author" content="weearc">
<link rel="canonical" href="https://blog.weearc.top/posts/2866972811/">
<meta name="google-site-verification" content="alQM1UuXbvXlVZiBJFDOVusGSakBpQYyv7f5x2tBGiw">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3c2040296aae8b5eb23e89af25f860a0e4acc3932d25385dad48cdfae63e7c43.css" integrity="sha256-PCBAKWqui16yPomvJfhgoOSsw5MtJThdrUjN&#43;uY&#43;fEM=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://blog.weearc.top/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.weearc.top/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.weearc.top/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.weearc.top/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.weearc.top/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">

<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas>
<script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
<script type="text/javascript" src="/js/fireworks.js"></script>


<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="记一次失败的从 Arch Linux 迁移到 Debian Sid 的经历" />
<meta property="og:description" content="其实我从来没想好自己应该使用什么发行版，十多年前最开始使用 Arch Linux 也只是因为觉得大家都在使用 什么 Ubuntu 啊觉得自己可以特例独行一些，并没有深刻的体会到什么叫做 KISS，也没有体会到各种拆包粒度对于使用的影响，也一直只是“会用”而已，并没有太多作为用户之外的使用体验差距。就算是第二个使用的发行版是 openSUSE 也一样，因为某种程度上有类似的基因。
起因 闲的蛋痛。年初企图迁移到 Fedora 失败，仅仅过了5个小时就滚回了 Arch 。可能考虑到了 Debian Sid 的如下特性，打算这次外迁一定要迁移出去，去 Debian。
足够稳定 apt 的前端 nala，看上去很帅 周围用 Arch 的很多，向特立独行一点 复习时间之余闲的蛋痛 但是也考虑到一些区别，比如：
包管理器的整合性：debian 系素以混乱的包管理功能著称，dpkg、apt、apt-get、apt-file 软件包获取的难度：这也是为什么我一直非常抗拒使用 deb 系，你可以在软件官网上（比如 zotero），在 github release，在 makedeb ，在 pacstall，在 ppa&hellip;你能找出一百个不同的软件包来源，但是你没办法把他们整合（Debian CN repo 许久未变更了） 不知道的一些奇奇怪怪的特性 wiki，debian wiki 也就将将是能参考的程度 以上这些问题并没罗列全面，但是我曾经认为自己能够克服这些问题。虽然显然还是太高看自己了。
Arch Linux -&gt; Debian 安装一个新的发行版是容易的，也没什么好说。但是考虑到年初 fedora 的惨痛经历，我打算还是给自己留个后路，方法可以有很多，rsync、或者整体dd、或者打个 tarball 什么的，之前有过尝试用 squashfs 备份系统的经验，而且打包后镜像体积特别小，也是很多发行版安装 CD 的首选方案。那就决定了。
首先备份根分区，需要排除掉所有额外挂载的分区和运行态的玩意儿：
1 sudo mksquashfs / backup-archlinux.squashfs -e /home -e /run -e /proc -e /dev -e /sys -e /tmp -e /var/tmp -e /mnt /boot/efi 直接把镜像扔到了外挂的 SSD 上面，体积也不大，150 G 根分区体积也就 27 G。然后下载了 Debian stable bookworm 的镜像，写盘，分区，安装&hellip;不一而足。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.weearc.top/posts/2866972811/" /><meta property="og:image" content="https://blog.weearc.top/papermod-cover.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-25T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-09-25T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.weearc.top/papermod-cover.png"/>

<meta name="twitter:title" content="记一次失败的从 Arch Linux 迁移到 Debian Sid 的经历"/>
<meta name="twitter:description" content="其实我从来没想好自己应该使用什么发行版，十多年前最开始使用 Arch Linux 也只是因为觉得大家都在使用 什么 Ubuntu 啊觉得自己可以特例独行一些，并没有深刻的体会到什么叫做 KISS，也没有体会到各种拆包粒度对于使用的影响，也一直只是“会用”而已，并没有太多作为用户之外的使用体验差距。就算是第二个使用的发行版是 openSUSE 也一样，因为某种程度上有类似的基因。
起因 闲的蛋痛。年初企图迁移到 Fedora 失败，仅仅过了5个小时就滚回了 Arch 。可能考虑到了 Debian Sid 的如下特性，打算这次外迁一定要迁移出去，去 Debian。
足够稳定 apt 的前端 nala，看上去很帅 周围用 Arch 的很多，向特立独行一点 复习时间之余闲的蛋痛 但是也考虑到一些区别，比如：
包管理器的整合性：debian 系素以混乱的包管理功能著称，dpkg、apt、apt-get、apt-file 软件包获取的难度：这也是为什么我一直非常抗拒使用 deb 系，你可以在软件官网上（比如 zotero），在 github release，在 makedeb ，在 pacstall，在 ppa&hellip;你能找出一百个不同的软件包来源，但是你没办法把他们整合（Debian CN repo 许久未变更了） 不知道的一些奇奇怪怪的特性 wiki，debian wiki 也就将将是能参考的程度 以上这些问题并没罗列全面，但是我曾经认为自己能够克服这些问题。虽然显然还是太高看自己了。
Arch Linux -&gt; Debian 安装一个新的发行版是容易的，也没什么好说。但是考虑到年初 fedora 的惨痛经历，我打算还是给自己留个后路，方法可以有很多，rsync、或者整体dd、或者打个 tarball 什么的，之前有过尝试用 squashfs 备份系统的经验，而且打包后镜像体积特别小，也是很多发行版安装 CD 的首选方案。那就决定了。
首先备份根分区，需要排除掉所有额外挂载的分区和运行态的玩意儿：
1 sudo mksquashfs / backup-archlinux.squashfs -e /home -e /run -e /proc -e /dev -e /sys -e /tmp -e /var/tmp -e /mnt /boot/efi 直接把镜像扔到了外挂的 SSD 上面，体积也不大，150 G 根分区体积也就 27 G。然后下载了 Debian stable bookworm 的镜像，写盘，分区，安装&hellip;不一而足。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://blog.weearc.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "记一次失败的从 Arch Linux 迁移到 Debian Sid 的经历",
      "item": "https://blog.weearc.top/posts/2866972811/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "记一次失败的从 Arch Linux 迁移到 Debian Sid 的经历",
  "name": "记一次失败的从 Arch Linux 迁移到 Debian Sid 的经历",
  "description": "其实我从来没想好自己应该使用什么发行版，十多年前最开始使用 Arch Linux 也只是因为觉得大家都在使用 什么 Ubuntu 啊觉得自己可以特例独行一些，并没有深刻的体会到什么叫做 KISS，也没有体会到各种拆包粒度对于使用的影响，也一直只是“会用”而已，并没有太多作为用户之外的使用体验差距。就算是第二个使用的发行版是 openSUSE 也一样，因为某种程度上有类似的基因。\n起因 闲的蛋痛。年初企图迁移到 Fedora 失败，仅仅过了5个小时就滚回了 Arch 。可能考虑到了 Debian Sid 的如下特性，打算这次外迁一定要迁移出去，去 Debian。\n足够稳定 apt 的前端 nala，看上去很帅 周围用 Arch 的很多，向特立独行一点 复习时间之余闲的蛋痛 但是也考虑到一些区别，比如：\n包管理器的整合性：debian 系素以混乱的包管理功能著称，dpkg、apt、apt-get、apt-file 软件包获取的难度：这也是为什么我一直非常抗拒使用 deb 系，你可以在软件官网上（比如 zotero），在 github release，在 makedeb ，在 pacstall，在 ppa\u0026hellip;你能找出一百个不同的软件包来源，但是你没办法把他们整合（Debian CN repo 许久未变更了） 不知道的一些奇奇怪怪的特性 wiki，debian wiki 也就将将是能参考的程度 以上这些问题并没罗列全面，但是我曾经认为自己能够克服这些问题。虽然显然还是太高看自己了。\nArch Linux -\u0026gt; Debian 安装一个新的发行版是容易的，也没什么好说。但是考虑到年初 fedora 的惨痛经历，我打算还是给自己留个后路，方法可以有很多，rsync、或者整体dd、或者打个 tarball 什么的，之前有过尝试用 squashfs 备份系统的经验，而且打包后镜像体积特别小，也是很多发行版安装 CD 的首选方案。那就决定了。\n首先备份根分区，需要排除掉所有额外挂载的分区和运行态的玩意儿：\n1 sudo mksquashfs / backup-archlinux.squashfs -e /home -e /run -e /proc -e /dev -e /sys -e /tmp -e /var/tmp -e /mnt /boot/efi 直接把镜像扔到了外挂的 SSD 上面，体积也不大，150 G 根分区体积也就 27 G。然后下载了 Debian stable bookworm 的镜像，写盘，分区，安装\u0026hellip;不一而足。",
  "keywords": [
    "archlinux", "系统迁移", "debian", "btrfs", "系统备份"
  ],
  "articleBody": "其实我从来没想好自己应该使用什么发行版，十多年前最开始使用 Arch Linux 也只是因为觉得大家都在使用 什么 Ubuntu 啊觉得自己可以特例独行一些，并没有深刻的体会到什么叫做 KISS，也没有体会到各种拆包粒度对于使用的影响，也一直只是“会用”而已，并没有太多作为用户之外的使用体验差距。就算是第二个使用的发行版是 openSUSE 也一样，因为某种程度上有类似的基因。\n起因 闲的蛋痛。年初企图迁移到 Fedora 失败，仅仅过了5个小时就滚回了 Arch 。可能考虑到了 Debian Sid 的如下特性，打算这次外迁一定要迁移出去，去 Debian。\n足够稳定 apt 的前端 nala，看上去很帅 周围用 Arch 的很多，向特立独行一点 复习时间之余闲的蛋痛 但是也考虑到一些区别，比如：\n包管理器的整合性：debian 系素以混乱的包管理功能著称，dpkg、apt、apt-get、apt-file 软件包获取的难度：这也是为什么我一直非常抗拒使用 deb 系，你可以在软件官网上（比如 zotero），在 github release，在 makedeb ，在 pacstall，在 ppa…你能找出一百个不同的软件包来源，但是你没办法把他们整合（Debian CN repo 许久未变更了） 不知道的一些奇奇怪怪的特性 wiki，debian wiki 也就将将是能参考的程度 以上这些问题并没罗列全面，但是我曾经认为自己能够克服这些问题。虽然显然还是太高看自己了。\nArch Linux -\u003e Debian 安装一个新的发行版是容易的，也没什么好说。但是考虑到年初 fedora 的惨痛经历，我打算还是给自己留个后路，方法可以有很多，rsync、或者整体dd、或者打个 tarball 什么的，之前有过尝试用 squashfs 备份系统的经验，而且打包后镜像体积特别小，也是很多发行版安装 CD 的首选方案。那就决定了。\n首先备份根分区，需要排除掉所有额外挂载的分区和运行态的玩意儿：\n1 sudo mksquashfs / backup-archlinux.squashfs -e /home -e /run -e /proc -e /dev -e /sys -e /tmp -e /var/tmp -e /mnt /boot/efi 直接把镜像扔到了外挂的 SSD 上面，体积也不大，150 G 根分区体积也就 27 G。然后下载了 Debian stable bookworm 的镜像，写盘，分区，安装…不一而足。\n装上 Debian 的第一件事就是把 nala 装上，apt 那个简陋的信息展示还是非常难受的，好在 Buster 以后已经默认在 main 里了。\n1 sudo apt install nala -y 然后发现自己不在 sudoers 里，得把自己手工添加进去：\n1 su - -c \"usermod -a -G sudo `whoami`\" 注销，重新登陆，sudo 可以正常使用了。\n接下来切换到 sid，直接编辑 /etc/apt/sources.list 内容如下：\n1 2 deb https://mirrors.cqu.edu.cn/debian sid main contrib non-free non-free-firmware # deb-src http://mirrors.cqu.edu.cn/debian sid main contrib non-free non-free-firmware 直接执行更新：\n1 sudo nala update \u0026\u0026 sudo nala upgrade -y 重启后切换为了 sid ，plasma 也更新到了 5.27.8。这时候给了我第一个下马威：/sbin/ 没 merge 到 /usr/bin ，问题不大，改个 /etc/profile 加个 PATH 的事。然后安装软件云云，不一而足。\n开始给自己找麻烦 从 QQ 开始，这时候我想到一个问题，我在 Arch 下可是用的 AUR 上魔改的 launcher 的启动脚本，要是 deb 每次装完都覆盖掉还是有点难受的。在 Arch 上我习惯于用 pacman hook 处理类似问题，但是 dpkg 好像没有 hook 可用。但是 stackexchange 上的某篇帖子和我的需求是一致的，都是需要更新后然后监听特定文件，并 patch 。那显然回答中的 file trigger 是一个可以使用的东西，那么需求明确了：\n创建一个带触发器的空包 空包中携带对于需要 patch 部分的脚本或源文件 安装触发器包后安装原 deb 包触发触发器 patched 之前曾经在 Arch 上给 deb 系打过 deb 包，所以创建包过程算是轻车熟路，只不过需要添加 DEBIAN/trigger 和 DEBIAN/postinst ， trigger 中 interest ，然后 postinst 脚本书写如下：\n1 2 3 4 5 6 7 8 9 #!/bin/bash if [ \"$1\" = \"triggered\" ] then if [ \"$2\" = \"\" ] then # do some patches fi exit 0 fi dpkg 在拦截监听器之后在入参上第一个参数是包状态，如果包被其他监听器“感兴趣”，那么第一个参数固定为 triggered ，第二个参数为监听的具体文件。这里需要注意的是，有些包会在后处理部分处理启动器文件等，而我们需要 patch 的部分也是这部分，就需要具体监听其他具体文件。另外所有打包脚本都需要空一行作为 EOF ，否则打包时必报错。\n因为特殊需要并没有增长，所以目前仅仅放了一部分 patch 在仓库中。很遗憾没法继续维护下去，以后大概也不会主动去维护。\n麻烦开始自己找上门 主要缘由在于我需要一个 Minecraft Launcher。而我常用的是 prismlauncher，但是！没有 deb 包。在 Arch 上没什么好说的，使用的甚至是 -git 版本不说而且是 Qt6 的包。以前打 Qt 包的经历自不必说，经常需要手动打包这样的项目还是非常难受的（难受在 debian 上 qt6 依赖并不全，或者可能拆包太细了我找不到）。前面提到了有 makedeb 这样的平台提供类似 PKGBUILD 的打包脚本并且有托管仓库，而里面，只有 stable 版本。但是毕竟本着能用就行要求不高的原则，先装上用一下。连着 jdk 装好后还姑且启动了几次 MC 1.16.5 试了一下看上去并没有大问题。\n接下来开始找 neovim，然后…源的版本是 0.7.2，我的配置文件是 0.9.2 的…不兼容不说，迁移过去也非常麻烦，这些配置文件是长年累月积攒下来的，迁移也是个大工程。那没办法，姑且用官方 binary 包用一下。能用就行。但是 vim…可就太麻烦了，我需要的包括 clipboard 的编译选项 debian 的几个 vim 包都是默认不开的。但是要是使用 vim-nox 的话又不完全支持我在用的插件。那只能先用 vim-common 凑合下了。然后，我 zotero 呢？plasma 5.27.8 不应该存在的 bug （夜览相关的） 怎么还有呢？我 grub-btrfs 呢？我 mmc 呢？我 freetype2 怎么这么多不相关的依赖它的呢？说好的拆包细呢？/usr/game 是什么上古遗留？我 usr-merge呢？有一种，自己的偏见问题主动离开亲妈去找后妈，结果后妈问题更多的即视感。\n想着先把那些放一放，咱们先把 Nvidia Optimus Sync 和显卡直出配了，然后查了一下 wiki , 被告知应当使用 nvidia-detect 检测脚本决定用什么驱动包。然后，该脚本检测到我的是 30 系移动端卡之后，自己退出了…好嘛，凭借在 Arch 上的经验，咱们先把开源驱动干掉，blacklist 之，然后装 nvidia-drivers 大概就没什么问题了。然后问题就来了，Debian Wiki 上给的 Optimus Sync 的 X11 配置文件样例，根本就不是做 Optimus Sync 的。那就还是参考一下 Arch Linux Wiki 姑且配一下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # /etc/X11/xorg.conf.d/10-nvidia-drm-outputclass.conf Section \"OutputClass\" Identifier \"intel\" MatchDriver \"i915\" Driver \"modesetting\" EndSection Section \"OutputClass\" Identifier \"nvidia\" MatchDriver \"nvidia-drm\" Driver \"nvidia\" Option \"AllowEmptyInitialConfiguration\" Option \"PrimaryGPU\" \"yes\" ModulePath \"/usr/lib/nvidia/xorg\" ModulePath \"/usr/lib/xorg/modules\" EndSection 但是，Debian 的 ModulePath 位置并不一致，需要找一下。不过问题也不大，总归dpkg -L 也能找到。但是问题就来了，nvidia-fbc 并没有随 nvidia-drivers 一起安装，nvenc 也并没法启用。但是总归是拆包的问题装上去就没问题了，大概。\n更加麻烦起来了 总体来说，虽然我的需求奇奇怪怪但是 Debian 大体上能满足，我也不多说什么。直到和群友聊起来，Minecraft 的 In-Game 打开文件夹没法打开。然后我试了一下，确实打不开。虽然资源包什么的我日常很少动，但是总归打不开还是很麻烦，明明我在 Arch 上都是行为正常的…. 打印了一下日志，发现如下问题:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 java.security.PrivilegedActionException: null at java.security.AccessController.doPrivileged(AccessController.java:573) ~[?:?] at net.minecraft.class_156$class_158.method_669(class_156.java:313) ~[client-intermediary.jar:?] at net.minecraft.class_156$class_158.method_673(class_156.java:324) ~[client-intermediary.jar:?] at net.minecraft.class_5375.method_29670(class_5375.java:102) ~[client-intermediary.jar:?] at net.minecraft.class_4185.method_25306(class_4185.java:94) ~[client-intermediary.jar:?] at net.minecraft.class_4264.method_25348(class_4264.java:56) ~[client-intermediary.jar:?] at net.minecraft.class_339.method_25402(class_339.java:189) ~[client-intermediary.jar:?] at net.minecraft.class_4069.method_25402(class_4069.java:38) ~[client-intermediary.jar:?] at net.minecraft.class_312.method_1611(class_312.java:98) ~[client-intermediary.jar:?] at net.minecraft.class_437.method_25412(class_437.java:409) ~[client-intermediary.jar:?] at net.minecraft.class_312.method_1601(class_312.java:98) ~[client-intermediary.jar:?] at net.minecraft.class_312.method_22686(class_312.java:169) ~[client-intermediary.jar:?] at net.minecraft.class_1255.execute(class_1255.java:102) ~[client-intermediary.jar:?] at net.minecraft.class_312.redirect$foc001$viafabricplus$redirectSync(class_312.java:3538) ~[client-intermediary.jar:?] at net.minecraft.class_312.method_22684(class_312.java:169) ~[client-intermediary.jar:?] at org.lwjgl.glfw.GLFWMouseButtonCallbackI.callback(GLFWMouseButtonCallbackI.java:43) ~[lwjgl-glfw-3.3.1.jar:?] at org.lwjgl.system.JNI.invokeV(Native Method) ~[lwjgl-3.3.1.jar:?] at org.lwjgl.glfw.GLFW.glfwWaitEventsTimeout(GLFW.java:3474) ~[lwjgl-glfw-3.3.1.jar:?] at com.mojang.blaze3d.systems.RenderSystem.limitDisplayFPS(RenderSystem.java:237) ~[client-intermediary.jar:?] at net.minecraft.class_310.method_1523(class_310.java:1244) ~[client-intermediary.jar:?] at net.minecraft.class_310.method_1514(class_310.java:802) ~[client-intermediary.jar:?] at net.minecraft.client.main.Main.main(Main.java:250) ~[minecraft-1.20.1-client.jar:?] at net.fabricmc.loader.impl.game.minecraft.MinecraftGameProvider.launch(MinecraftGameProvider.java:468) ~[fabric-loader-0.14.21.jar:?] at net.fabricmc.loader.impl.launch.knot.Knot.launch(Knot.java:74) ~[fabric-loader-0.14.21.jar:?] at net.fabricmc.loader.impl.launch.knot.KnotClient.main(KnotClient.java:23) ~[fabric-loader-0.14.21.jar:?] at org.prismlauncher.launcher.impl.StandardLauncher.launch(StandardLauncher.java:88) ~[NewLaunch.jar:?] at org.prismlauncher.EntryPoint.listen(EntryPoint.java:126) ~[NewLaunch.jar:?] at org.prismlauncher.EntryPoint.main(EntryPoint.java:71) ~[NewLaunch.jar:?] Caused by: java.io.IOException: Cannot run program \"xdg-open\": error=13, 权限不够 at java.lang.ProcessBuilder.start(ProcessBuilder.java:1143) ~[?:?] at java.lang.ProcessBuilder.start(ProcessBuilder.java:1073) ~[?:?] at java.lang.Runtime.exec(Runtime.java:594) ~[?:?] at java.lang.Runtime.exec(Runtime.java:453) ~[?:?] at net.minecraft.class_156$class_158.method_671(class_156.java:313) ~[client-intermediary.jar:?] at java.security.AccessController.doPrivileged(AccessController.java:569) ~[?:?] ... 27 more Caused by: java.io.IOException: error=13, 权限不够 at java.lang.ProcessImpl.forkAndExec(Native Method) ~[?:?] at java.lang.ProcessImpl.\u003cinit\u003e(ProcessImpl.java:314) ~[?:?] at java.lang.ProcessImpl.start(ProcessImpl.java:244) ~[?:?] at java.lang.ProcessBuilder.start(ProcessBuilder.java:1110) ~[?:?] at java.lang.ProcessBuilder.start(ProcessBuilder.java:1073) ~[?:?] at java.lang.Runtime.exec(Runtime.java:594) ~[?:?] at java.lang.Runtime.exec(Runtime.java:453) ~[?:?] at net.minecraft.class_156$class_158.method_671(class_156.java:313) ~[client-intermediary.jar:?] at java.security.AccessController.doPrivileged(AccessController.java:569) ~[?:?] ... 27 more 我写 java ，我也用 process builder 调用过，但问题是这问题是怎么会权限不够的。查了一下 java 的进程，归属于我的账户下，而且 jdk 在家目录，按理讲权限是足够的，而且 xdg-open 本身不是 /sbin 下的脚本。于是决定写个 Demo 验证下问题。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # OpenURL.java import java.io.IOException; public class OpenURL { public static void main(String[] args) { String url = \"file:/home/ddqi/\"; try { ProcessBuilder processBuilder = new ProcessBuilder(\"xdg-open\", url); Process process = processBuilder.start(); int exitCode = process.waitFor(); if (exitCode == 0) { System.out.println(\"成功打开URL: \" + url); } else { System.err.println(\"无法打开URL: \" + url); } } catch (IOException | InterruptedException e) { e.printStackTrace(); } } } 1 2 3 # MANIFEST.MF Manifest-Version: 1.0 Main-Class: OpenURL 然后用 jdk17 编译打包一下：\n1 2 3 javac OpenURL.java jar -cfm OpenURL.jar MANIFEST.MF OpenURL.class 运行：\n1 java -jar OpenURL.jar 很明显的一个问题，报错和 MC 的报错一致。说明可能不是代码的问题。思路转变一下，CentOS 上我被 SELinux 恶心过，但是还有个东西是其他发行版上用的，Apparmor，也是内核级别的，我打自己的内核时候都是去掉支持的。那么没办法，先至少关掉 Apparmor 试一下，添加内核参数，重启，然后 aa-status 一下，确认关闭。重新运行一次该 jar 文件，得到成功响应但是却无法拉起 dolphin 的问题。那估计只能是 jdk 少东西了或者依赖什么少了…\n于是开始重复：改 Apparmor 规则，跑 demo 验证。但是连最开始没出现问题的 jdk8 在 demo 中行为也不正常。按理来讲 Apparmor 启用时候至少 jdk8 行为在 In-Game 中是正常的，java17 的可能是撞了 java 自己的安全策略。但是这样的话又解释不清同一套 jdk 为什么在 Arch 上就行为正常。（这里定义正常行为为未开启任何策略下，java process builder 能够掉用其他 os 的套件拉起进程）\nDebian -\u003e Arch LInux 正常情况下发现问题，分析问题，解决问题对于正常人来说是一个正常的流程。但是这是一个 不正常的问题，我的怒气值已经满了，以及我最低的要求都满足不了我要你干甚。惹不起老子躲不起吗，走走走打道回府。\n安装回去的流程更简单，本身 squashfs 就是根分区的最小完整克隆。释放回去就完事了。步骤还是轻车熟路：下 live CD，写盘，重启。\n直接格调这个折磨我心态到爆炸的 Debian :\n1 2 # -f 强制重做文件系统 mkfs.btrfs -f /dev/nvme1n1p2 然后把外接 SSD 挂上来看看原来的 fstab 怎么写：\n1 2 3 4 5 6 7 mkdir -p {test,test1} mount /dev/sda1 ./test mount ./test/backup-archlinux.squashfs ./test1 cat ./test1/etc/fstab 分区布局是这样的：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 # /dev/nvme1n1p2 UUID=be72b201-80a6-4224-ba13-4bb6e0414577 / btrfs rw,relatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=256,subvol=/@ 0 0 # /dev/nvme1n1p2 UUID=be72b201-80a6-4224-ba13-4bb6e0414577 /tmp btrfs rw,relatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=257,subvol=/@tmp 0 0 # /dev/nvme1n1p2 UUID=be72b201-80a6-4224-ba13-4bb6e0414577 /usr/local btrfs rw,relatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=258,subvol=/@usr_local 0 0 # /dev/nvme1n1p2 UUID=be72b201-80a6-4224-ba13-4bb6e0414577 /var/log btrfs rw,relatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=259,subvol=/@var_log 0 0 # /dev/nvme0n1p1 LABEL=SYSTEM UUID=BE42-0216 /boot/efi vfat rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=ascii,shortname=mixed,utf8,errors=remount-ro 0 2 # /dev/nvme1n1p3 UUID=97ed42a1-e595-4009-81f0-470f9d183109 /home ext4 rw,relatime 0 2 # /dev/nvme1n1p2 UUID=be72b201-80a6-4224-ba13-4bb6e0414577 /.snapshots btrfs rw,relatime,compress=zstd:3,ssd,discard=async,space_cache=v2,subvolid=260,subvol=/@snapshots 0 0 那子卷布局还是按照原来的做：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # 先把根挂上来,开启压缩（必须和打包前的分区inode保持一致） mount -o compress=zstd /dev/nvme1n1p2 /mnt # 根分区 btrfs subvolume create /mnt/@ # /tmp btrfs subvolume create /mnt/@tmp # /var/log btrfs subvolume create /mnt/@var_log # /usr/local btrfs subvolume create /mnt/@usr_local # /.snapshots btrfs subvolume create /mnt/@snapshots # 卸载根分区 umount /mnt 接着直接挂分区：\n1 2 3 4 5 6 7 8 9 10 11 12 # 根分区和子卷 mount -o compress=zstd,subvol=@ /dev/nvme1n1p2 /mnt # 创建挂载点 mkdir -p /mnt/{home.usr/local,proc.run,sys,media,dev,var/log,tmp,.snapshots,boot/efi} # 挂载其他子卷 mount -o compress=zstd,subvol=@tmp /dev/nvme1n1p2 /mnt/tmp mount -o compress=zstd,subvol=@var_log /dev/nvme1n1p2 /mnt/var/log mount -o compress=zstd,subvol=@usr_local /dev/nvme1n1p2 /mnt/usr/local mount -o compress=zstd,subvol=@snapshots /dev/nvme1n1p2 /mnt/.snapshots # efi 和 home mount /dev/nvme0n1p1 /mnt/boot/efi mount /dev/nvme1n1p3 /mnt/home 释放镜像：\n1 2 3 4 # 取消挂载镜像 umount ./test1 # 释放镜像 unsquashfs -f -d /mnt test/backup-archlinux.squashfs 完成后基本就没什么问题了，但是需要重新装一下 grub：\n1 2 3 4 5 6 7 8 # chroot 到系统 arch-chroot /mnt # 删除旧的 grub 引导 rm -rf /boot/efi/EFI/Debian # 装载引导器 grub-install --target=x86_64-efi --efi-directory=/boot/efi/ --recheck # 生成配置 grub-mkconfig -o /boot/grub/grub.cfg 由于根分区 UUID 变了，因为 fstab 还是得改一下，直接退出 chroot 环境，执行：\n1 genfstab -U /mnt \u003e\u003e /mnt/etc/fstab 重启一下发现又回到和蔼可亲的 Arch Linux 了。\n总结 先排除自己的菜的原因。我可能菜，但是桌面系统用的如此憋屈感觉应该不全是我的问题…每次想从 Arch 叛逃，但是又逃回来，每次都是走之前觉得 Arch 这不好那不好骗自己能有办法安心在新发行版下熟悉，但是用着用着却又想起之前的各个好处。尤其是有 aur 这样的整合的，统一的平台这件事。省去了很多麻烦，也方便统一管理。\n但是话又说回来，现在的自己竟然这么习惯于逃避了…果然是因为害怕的事情变多了的缘故么。\n",
  "wordCount" : "1109",
  "inLanguage": "zh",
  "datePublished": "2023-09-25T00:00:00Z",
  "dateModified": "2023-09-25T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "weearc"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.weearc.top/posts/2866972811/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "weearc 的个人博客",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.weearc.top/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">

<header class="header" id="navBar">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.weearc.top" accesskey="h" title="weearc 的个人博客 (Alt + H)">weearc 的个人博客</a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.weearc.top/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="https://blog.weearc.top/archives" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="https://blog.weearc.top/search/" title="检索">
                    <span>检索</span>
                </a>
            </li>
            <li>
                <a href="https://blog.weearc.top/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="https://blog.weearc.top/about/" title="关于我">
                    <span>关于我</span>
                </a>
            </li>
            <li>
                <a href="https://blog.weearc.top/frlink/" title="友链">
                    <span>友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main beforeScrollMaster" id="list-layout">
        <div id="content-list">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.weearc.top">主页</a>&nbsp;»&nbsp;<a href="https://blog.weearc.top/posts/">Posts</a></div>
    <h1 class="post-title">
      记一次失败的从 Arch Linux 迁移到 Debian Sid 的经历
    </h1>
    <div class="post-meta"><span title='2023-09-25 00:00:00 +0000 UTC'>九月 25, 2023</span>&nbsp;·&nbsp;6 分钟&nbsp;·&nbsp;weearc

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e8%b5%b7%e5%9b%a0" aria-label="起因">起因</a></li>
                <li>
                    <a href="#arch-linux---debian" aria-label="Arch Linux -&amp;gt; Debian">Arch Linux -&gt; Debian</a><ul>
                        
                <li>
                    <a href="#%e5%bc%80%e5%a7%8b%e7%bb%99%e8%87%aa%e5%b7%b1%e6%89%be%e9%ba%bb%e7%83%a6" aria-label="开始给自己找麻烦">开始给自己找麻烦</a></li>
                <li>
                    <a href="#%e9%ba%bb%e7%83%a6%e5%bc%80%e5%a7%8b%e8%87%aa%e5%b7%b1%e6%89%be%e4%b8%8a%e9%97%a8" aria-label="麻烦开始自己找上门">麻烦开始自己找上门</a></li>
                <li>
                    <a href="#%e6%9b%b4%e5%8a%a0%e9%ba%bb%e7%83%a6%e8%b5%b7%e6%9d%a5%e4%ba%86" aria-label="更加麻烦起来了">更加麻烦起来了</a></li></ul>
                </li>
                <li>
                    <a href="#debian---arch-linux" aria-label="Debian -&amp;gt; Arch LInux">Debian -&gt; Arch LInux</a></li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>其实我从来没想好自己应该使用什么发行版，十多年前最开始使用 Arch Linux 也只是因为觉得大家都在使用 什么 Ubuntu 啊觉得自己可以特例独行一些，并没有深刻的体会到什么叫做 KISS，也没有体会到各种拆包粒度对于使用的影响，也一直只是“会用”而已，并没有太多作为用户之外的使用体验差距。就算是第二个使用的发行版是 openSUSE 也一样，因为某种程度上有类似的基因。</p>
<!--detail-->
<h2 id="起因">起因<a hidden class="anchor" aria-hidden="true" href="#起因">#</a></h2>
<p>闲的蛋痛。年初企图迁移到 Fedora 失败，仅仅过了5个小时就滚回了 Arch 。可能考虑到了 Debian Sid 的如下特性，打算这次外迁一定要迁移出去，去 Debian。</p>
<ul>
<li>足够稳定</li>
<li>apt 的前端 nala，看上去很帅</li>
<li>周围用 Arch 的很多，向特立独行一点</li>
<li>复习时间之余闲的蛋痛</li>
</ul>
<p>但是也考虑到一些区别，比如：</p>
<ul>
<li>包管理器的整合性：debian 系素以混乱的包管理功能著称，dpkg、apt、apt-get、apt-file</li>
<li>软件包获取的难度：这也是为什么我一直非常抗拒使用 deb 系，你可以在软件官网上（比如 zotero），在 github release，在 makedeb ，在 pacstall，在 ppa&hellip;你能找出一百个不同的软件包来源，但是你没办法把他们整合（Debian CN repo 许久未变更了）</li>
<li>不知道的一些奇奇怪怪的特性</li>
<li>wiki，debian wiki 也就将将是能参考的程度</li>
</ul>
<p>以上这些问题并没罗列全面，但是我曾经认为自己能够克服这些问题。虽然显然还是太高看自己了。</p>
<h2 id="arch-linux---debian">Arch Linux -&gt; Debian<a hidden class="anchor" aria-hidden="true" href="#arch-linux---debian">#</a></h2>
<p>安装一个新的发行版是容易的，也没什么好说。但是考虑到年初 fedora 的惨痛经历，我打算还是给自己留个后路，方法可以有很多，rsync、或者整体dd、或者打个 tarball 什么的，之前有过尝试用 squashfs 备份系统的经验，而且打包后镜像体积特别小，也是很多发行版安装 CD 的首选方案。那就决定了。</p>
<p>首先备份根分区，需要排除掉所有额外挂载的分区和运行态的玩意儿：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo mksquashfs / backup-archlinux.squashfs -e /home -e /run -e /proc -e /dev -e /sys -e /tmp -e /var/tmp -e /mnt /boot/efi
</span></span></code></pre></td></tr></table>
</div>
</div><p>直接把镜像扔到了外挂的 SSD 上面，体积也不大，150 G 根分区体积也就 27 G。然后下载了 Debian stable bookworm 的镜像，写盘，分区，安装&hellip;不一而足。</p>
<p>装上 Debian 的第一件事就是把 nala 装上，apt 那个简陋的信息展示还是非常难受的，好在 Buster 以后已经默认在 main 里了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo apt install nala -y
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后发现自己不在 sudoers 里，得把自己手工添加进去：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">su - -c <span class="s2">&#34;usermod -a -G sudo `whoami`&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>注销，重新登陆，sudo 可以正常使用了。</p>
<p>接下来切换到 sid，直接编辑 <code>/etc/apt/sources.list</code> 内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">deb https://mirrors.cqu.edu.cn/debian sid main contrib non-free non-free-firmware
</span></span><span class="line"><span class="cl"># deb-src http://mirrors.cqu.edu.cn/debian sid main contrib non-free non-free-firmware
</span></span></code></pre></td></tr></table>
</div>
</div><p>直接执行更新：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo nala update <span class="o">&amp;&amp;</span> sudo nala upgrade -y
</span></span></code></pre></td></tr></table>
</div>
</div><p>重启后切换为了 sid ，plasma 也更新到了 5.27.8。这时候给了我第一个下马威：<code>/sbin/</code> 没 merge 到 <code>/usr/bin</code> ，问题不大，改个 <code>/etc/profile</code> 加个 PATH 的事。然后安装软件云云，不一而足。</p>
<h3 id="开始给自己找麻烦">开始给自己找麻烦<a hidden class="anchor" aria-hidden="true" href="#开始给自己找麻烦">#</a></h3>
<p>从 QQ 开始，这时候我想到一个问题，我在 Arch 下可是用的 AUR 上魔改的 launcher 的启动脚本，要是 deb 每次装完都覆盖掉还是有点难受的。在 Arch 上我习惯于用 pacman hook 处理类似问题，但是 dpkg 好像没有 hook 可用。但是 stackexchange 上的<a href="https://unix.stackexchange.com/questions/492697/cleaner-way-to-detect-if-a-particular-package-was-installed-in-apt-get-hook">某篇帖子</a>和我的需求是一致的，都是需要更新后然后监听特定文件，并 patch 。那显然回答中的 file trigger 是一个可以使用的东西，那么需求明确了：</p>
<ol>
<li>创建一个带触发器的空包</li>
<li>空包中携带对于需要 patch 部分的脚本或源文件</li>
<li>安装触发器包后安装原 deb 包触发触发器</li>
<li>patched</li>
</ol>
<p>之前曾经在 Arch 上给 deb 系打过 deb 包，所以创建包过程算是轻车熟路，只不过需要添加 <code>DEBIAN/trigger</code> 和 <code>DEBIAN/postinst</code> ， trigger 中 <code>interest &lt;path/to/file&gt;</code> ，然后 postinst 脚本书写如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;triggered&#34;</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="k">then</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span> <span class="o">=</span> <span class="s2">&#34;&lt;path/to/file/triggered&gt;&#34;</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl">  <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># do some patches</span>
</span></span><span class="line"><span class="cl">  <span class="k">fi</span>
</span></span><span class="line"><span class="cl">  <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>dpkg 在拦截监听器之后在入参上第一个参数是包状态，如果包被其他监听器“感兴趣”，那么第一个参数固定为 <code>triggered</code> ，第二个参数为监听的具体文件。这里需要注意的是，有些包会在后处理部分处理启动器文件等，而我们需要 patch 的部分也是这部分，就需要具体监听其他具体文件。另外所有打包脚本都需要空一行作为 EOF ，否则打包时必报错。</p>
<blockquote>
<p>因为特殊需要并没有增长，所以目前仅仅放了一部分 patch 在<a href="https://github.com/weearc/debian-custom-trigger">仓库</a>中。很遗憾没法继续维护下去，以后大概也不会主动去维护。</p>
</blockquote>
<h3 id="麻烦开始自己找上门">麻烦开始自己找上门<a hidden class="anchor" aria-hidden="true" href="#麻烦开始自己找上门">#</a></h3>
<p>主要缘由在于我需要一个 Minecraft Launcher。而我常用的是 prismlauncher，但是！没有 deb 包。在 Arch 上没什么好说的，使用的甚至是 <code>-git</code> 版本不说而且是 Qt6 的包。以前打 Qt 包的经历自不必说，经常需要手动打包这样的项目还是非常难受的（难受在 debian 上 qt6 依赖并不全，或者可能拆包太细了我找不到）。前面提到了有 makedeb 这样的平台提供类似 PKGBUILD 的打包脚本并且有托管仓库，而里面，只有 stable 版本。但是毕竟本着能用就行要求不高的原则，先装上用一下。连着 jdk 装好后还姑且启动了几次 MC 1.16.5 试了一下看上去并没有大问题。</p>
<p>接下来开始找 neovim，然后&hellip;源的版本是 0.7.2，我的配置文件是 0.9.2 的&hellip;不兼容不说，迁移过去也非常麻烦，这些配置文件是长年累月积攒下来的，迁移也是个大工程。那没办法，姑且用官方 binary 包用一下。能用就行。但是 vim&hellip;可就太麻烦了，我需要的包括 clipboard 的编译选项 debian 的几个 vim 包都是默认不开的。但是要是使用 vim-nox 的话又不完全支持我在用的插件。那只能先用 vim-common 凑合下了。然后，我 zotero 呢？plasma 5.27.8 不应该存在的 bug （夜览相关的） 怎么还有呢？我 grub-btrfs 呢？我 mmc 呢？我 freetype2 怎么这么多不相关的依赖它的呢？说好的拆包细呢？<code>/usr/game</code> 是什么上古遗留？我 <code>usr-merge</code>呢？有一种，自己的偏见问题主动离开亲妈去找后妈，结果后妈问题更多的即视感。</p>
<p>想着先把那些放一放，咱们先把 Nvidia Optimus Sync 和显卡直出配了，然后查了一下 wiki , 被告知应当使用 <code>nvidia-detect</code> 检测脚本决定用什么驱动包。然后，该脚本检测到我的是 30 系移动端卡之后，自己退出了&hellip;好嘛，凭借在 Arch 上的经验，咱们先把开源驱动干掉，blacklist 之，然后装 <code>nvidia-drivers</code> 大概就没什么问题了。然后问题就来了，Debian Wiki 上给的 Optimus Sync 的 X11 配置文件样例，根本就不是做 Optimus Sync 的。那就还是参考一下 <a href="https://wiki.archlinux.org/title/NVIDIA_Optimus#Use_NVIDIA_graphics_only">Arch Linux Wiki</a> 姑且配一下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># /etc/X11/xorg.conf.d/10-nvidia-drm-outputclass.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Section &#34;OutputClass&#34;
</span></span><span class="line"><span class="cl">    Identifier &#34;intel&#34;
</span></span><span class="line"><span class="cl">    MatchDriver &#34;i915&#34;
</span></span><span class="line"><span class="cl">    Driver &#34;modesetting&#34;
</span></span><span class="line"><span class="cl">EndSection
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Section &#34;OutputClass&#34;
</span></span><span class="line"><span class="cl">    Identifier &#34;nvidia&#34;
</span></span><span class="line"><span class="cl">    MatchDriver &#34;nvidia-drm&#34;
</span></span><span class="line"><span class="cl">    Driver &#34;nvidia&#34;
</span></span><span class="line"><span class="cl">    Option &#34;AllowEmptyInitialConfiguration&#34;
</span></span><span class="line"><span class="cl">    Option &#34;PrimaryGPU&#34; &#34;yes&#34;
</span></span><span class="line"><span class="cl">    ModulePath &#34;/usr/lib/nvidia/xorg&#34;
</span></span><span class="line"><span class="cl">    ModulePath &#34;/usr/lib/xorg/modules&#34;
</span></span><span class="line"><span class="cl">EndSection
</span></span></code></pre></td></tr></table>
</div>
</div><p>但是，Debian 的 ModulePath 位置并不一致，需要找一下。不过问题也不大，总归<code>dpkg -L</code> 也能找到。但是问题就来了，nvidia-fbc 并没有随 nvidia-drivers 一起安装，nvenc 也并没法启用。但是总归是拆包的问题装上去就没问题了，大概。</p>
<h3 id="更加麻烦起来了">更加麻烦起来了<a hidden class="anchor" aria-hidden="true" href="#更加麻烦起来了">#</a></h3>
<p>总体来说，虽然我的需求奇奇怪怪但是 Debian 大体上能满足，我也不多说什么。直到和群友聊起来，Minecraft 的 In-Game 打开文件夹没法打开。然后我试了一下，确实打不开。虽然资源包什么的我日常很少动，但是总归打不开还是很麻烦，明明我在 Arch 上都是行为正常的&hellip;. 打印了一下日志，发现如下问题:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">PrivilegedActionException</span><span class="o">:</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="n">AccessController</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">573</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_156$class_158</span><span class="o">.</span><span class="na">method_669</span><span class="o">(</span><span class="n">class_156</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">313</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_156$class_158</span><span class="o">.</span><span class="na">method_673</span><span class="o">(</span><span class="n">class_156</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">324</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_5375</span><span class="o">.</span><span class="na">method_29670</span><span class="o">(</span><span class="n">class_5375</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">102</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_4185</span><span class="o">.</span><span class="na">method_25306</span><span class="o">(</span><span class="n">class_4185</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">94</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_4264</span><span class="o">.</span><span class="na">method_25348</span><span class="o">(</span><span class="n">class_4264</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">56</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_339</span><span class="o">.</span><span class="na">method_25402</span><span class="o">(</span><span class="n">class_339</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">189</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_4069</span><span class="o">.</span><span class="na">method_25402</span><span class="o">(</span><span class="n">class_4069</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">38</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_312</span><span class="o">.</span><span class="na">method_1611</span><span class="o">(</span><span class="n">class_312</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">98</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_437</span><span class="o">.</span><span class="na">method_25412</span><span class="o">(</span><span class="n">class_437</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">409</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_312</span><span class="o">.</span><span class="na">method_1601</span><span class="o">(</span><span class="n">class_312</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">98</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_312</span><span class="o">.</span><span class="na">method_22686</span><span class="o">(</span><span class="n">class_312</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">169</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_1255</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">class_1255</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">102</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_312</span><span class="o">.</span><span class="na">redirect$foc001$viafabricplus$redirectSync</span><span class="o">(</span><span class="n">class_312</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">3538</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_312</span><span class="o">.</span><span class="na">method_22684</span><span class="o">(</span><span class="n">class_312</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">169</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">lwjgl</span><span class="o">.</span><span class="na">glfw</span><span class="o">.</span><span class="na">GLFWMouseButtonCallbackI</span><span class="o">.</span><span class="na">callback</span><span class="o">(</span><span class="n">GLFWMouseButtonCallbackI</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">43</span><span class="o">)</span> <span class="o">~[</span><span class="n">lwjgl</span><span class="o">-</span><span class="n">glfw</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="na">3</span><span class="o">.</span><span class="na">1</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">lwjgl</span><span class="o">.</span><span class="na">system</span><span class="o">.</span><span class="na">JNI</span><span class="o">.</span><span class="na">invokeV</span><span class="o">(</span><span class="n">Native</span> <span class="n">Method</span><span class="o">)</span> <span class="o">~[</span><span class="n">lwjgl</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="na">3</span><span class="o">.</span><span class="na">1</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">lwjgl</span><span class="o">.</span><span class="na">glfw</span><span class="o">.</span><span class="na">GLFW</span><span class="o">.</span><span class="na">glfwWaitEventsTimeout</span><span class="o">(</span><span class="n">GLFW</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">3474</span><span class="o">)</span> <span class="o">~[</span><span class="n">lwjgl</span><span class="o">-</span><span class="n">glfw</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="na">3</span><span class="o">.</span><span class="na">1</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">com</span><span class="o">.</span><span class="na">mojang</span><span class="o">.</span><span class="na">blaze3d</span><span class="o">.</span><span class="na">systems</span><span class="o">.</span><span class="na">RenderSystem</span><span class="o">.</span><span class="na">limitDisplayFPS</span><span class="o">(</span><span class="n">RenderSystem</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">237</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_310</span><span class="o">.</span><span class="na">method_1523</span><span class="o">(</span><span class="n">class_310</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1244</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_310</span><span class="o">.</span><span class="na">method_1514</span><span class="o">(</span><span class="n">class_310</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">802</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">main</span><span class="o">.</span><span class="na">Main</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">Main</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">250</span><span class="o">)</span> <span class="o">~[</span><span class="n">minecraft</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="na">20</span><span class="o">.</span><span class="na">1</span><span class="o">-</span><span class="n">client</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">fabricmc</span><span class="o">.</span><span class="na">loader</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">game</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">MinecraftGameProvider</span><span class="o">.</span><span class="na">launch</span><span class="o">(</span><span class="n">MinecraftGameProvider</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">468</span><span class="o">)</span> <span class="o">~[</span><span class="n">fabric</span><span class="o">-</span><span class="n">loader</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="na">14</span><span class="o">.</span><span class="na">21</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">fabricmc</span><span class="o">.</span><span class="na">loader</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">launch</span><span class="o">.</span><span class="na">knot</span><span class="o">.</span><span class="na">Knot</span><span class="o">.</span><span class="na">launch</span><span class="o">(</span><span class="n">Knot</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">74</span><span class="o">)</span> <span class="o">~[</span><span class="n">fabric</span><span class="o">-</span><span class="n">loader</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="na">14</span><span class="o">.</span><span class="na">21</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">fabricmc</span><span class="o">.</span><span class="na">loader</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">launch</span><span class="o">.</span><span class="na">knot</span><span class="o">.</span><span class="na">KnotClient</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">KnotClient</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">23</span><span class="o">)</span> <span class="o">~[</span><span class="n">fabric</span><span class="o">-</span><span class="n">loader</span><span class="o">-</span><span class="mi">0</span><span class="o">.</span><span class="na">14</span><span class="o">.</span><span class="na">21</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">prismlauncher</span><span class="o">.</span><span class="na">launcher</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">StandardLauncher</span><span class="o">.</span><span class="na">launch</span><span class="o">(</span><span class="n">StandardLauncher</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">88</span><span class="o">)</span> <span class="o">~[</span><span class="n">NewLaunch</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">prismlauncher</span><span class="o">.</span><span class="na">EntryPoint</span><span class="o">.</span><span class="na">listen</span><span class="o">(</span><span class="n">EntryPoint</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">126</span><span class="o">)</span> <span class="o">~[</span><span class="n">NewLaunch</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">prismlauncher</span><span class="o">.</span><span class="na">EntryPoint</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">EntryPoint</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">71</span><span class="o">)</span> <span class="o">~[</span><span class="n">NewLaunch</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl"><span class="n">Caused</span> <span class="n">by</span><span class="o">:</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">:</span> <span class="n">Cannot</span> <span class="n">run</span> <span class="n">program</span> <span class="s">&#34;xdg-open&#34;</span><span class="o">:</span> <span class="n">error</span><span class="o">=</span><span class="mi">13</span><span class="o">,</span> <span class="n">权限不够</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ProcessBuilder</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">ProcessBuilder</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1143</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ProcessBuilder</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">ProcessBuilder</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1073</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Runtime</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">594</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Runtime</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">453</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_156$class_158</span><span class="o">.</span><span class="na">method_671</span><span class="o">(</span><span class="n">class_156</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">313</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="n">AccessController</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">569</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span> <span class="mi">27</span> <span class="n">more</span>
</span></span><span class="line"><span class="cl"><span class="n">Caused</span> <span class="n">by</span><span class="o">:</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">:</span> <span class="n">error</span><span class="o">=</span><span class="mi">13</span><span class="o">,</span> <span class="n">权限不够</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ProcessImpl</span><span class="o">.</span><span class="na">forkAndExec</span><span class="o">(</span><span class="n">Native</span> <span class="n">Method</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ProcessImpl</span><span class="o">.&lt;</span><span class="n">init</span><span class="o">&gt;(</span><span class="n">ProcessImpl</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">314</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ProcessImpl</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">ProcessImpl</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">244</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ProcessBuilder</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">ProcessBuilder</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1110</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">ProcessBuilder</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">ProcessBuilder</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1073</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Runtime</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">594</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Runtime</span><span class="o">.</span><span class="na">exec</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">453</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">net</span><span class="o">.</span><span class="na">minecraft</span><span class="o">.</span><span class="na">class_156$class_158</span><span class="o">.</span><span class="na">method_671</span><span class="o">(</span><span class="n">class_156</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">313</span><span class="o">)</span> <span class="o">~[</span><span class="n">client</span><span class="o">-</span><span class="n">intermediary</span><span class="o">.</span><span class="na">jar</span><span class="o">:?]</span>
</span></span><span class="line"><span class="cl">  <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span><span class="n">AccessController</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">569</span><span class="o">)</span> <span class="o">~[?:?]</span>
</span></span><span class="line"><span class="cl">  <span class="o">...</span> <span class="mi">27</span> <span class="n">more</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我写 java ，我也用 process builder 调用过，但问题是这问题是怎么会权限不够的。查了一下 java 的进程，归属于我的账户下，而且 jdk 在家目录，按理讲权限是足够的，而且 <code>xdg-open</code> 本身不是 <code>/sbin</code> 下的脚本。于是决定写个 Demo 验证下问题。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="err">#</span> <span class="n">OpenURL</span><span class="o">.</span><span class="na">java</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OpenURL</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">&#34;file:/home/ddqi/&#34;</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ProcessBuilder</span> <span class="n">processBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessBuilder</span><span class="o">(</span><span class="s">&#34;xdg-open&#34;</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">Process</span> <span class="n">process</span> <span class="o">=</span> <span class="n">processBuilder</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">exitCode</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="na">waitFor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">exitCode</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;成功打开URL: &#34;</span> <span class="o">+</span> <span class="n">url</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;无法打开URL: &#34;</span> <span class="o">+</span> <span class="n">url</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="o">|</span> <span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># MANIFEST.MF
</span></span><span class="line"><span class="cl">Manifest-Version: 1.0
</span></span><span class="line"><span class="cl">Main-Class: OpenURL
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后用 jdk17 编译打包一下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">javac OpenURL.java
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">jar -cfm OpenURL.jar MANIFEST.MF OpenURL.class
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">java -jar OpenURL.jar
</span></span></code></pre></td></tr></table>
</div>
</div><p>很明显的一个问题，报错和 MC 的报错一致。说明可能不是代码的问题。思路转变一下，CentOS 上我被 SELinux 恶心过，但是还有个东西是其他发行版上用的，Apparmor，也是内核级别的，我打自己的内核时候都是去掉支持的。那么没办法，先至少关掉 Apparmor 试一下，添加内核参数，重启，然后 <code>aa-status</code> 一下，确认关闭。重新运行一次该 jar 文件，得到成功响应但是却无法拉起 dolphin 的问题。那估计只能是 jdk 少东西了或者依赖什么少了&hellip;</p>
<p>于是开始重复：改 Apparmor 规则，跑 demo 验证。但是连最开始没出现问题的 jdk8 在 demo 中行为也不正常。按理来讲 Apparmor 启用时候至少 jdk8 行为在 In-Game 中是正常的，java17 的可能是撞了 java 自己的安全策略。但是这样的话又解释不清同一套 jdk 为什么在 Arch 上就行为正常。（这里定义正常行为为未开启任何策略下，java process builder 能够掉用其他 os 的套件拉起进程）</p>
<h2 id="debian---arch-linux">Debian -&gt; Arch LInux<a hidden class="anchor" aria-hidden="true" href="#debian---arch-linux">#</a></h2>
<p>正常情况下发现问题，分析问题，解决问题对于正常人来说是一个正常的流程。但是这是一个 不正常的问题，我的怒气值已经满了，以及我最低的要求都满足不了我要你干甚。惹不起老子躲不起吗，走走走打道回府。</p>
<p>安装回去的流程更简单，本身 squashfs 就是根分区的最小完整克隆。释放回去就完事了。步骤还是轻车熟路：下 live CD，写盘，重启。</p>
<p>直接格调这个折磨我心态到爆炸的 Debian :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># -f 强制重做文件系统</span>
</span></span><span class="line"><span class="cl">mkfs.btrfs -f /dev/nvme1n1p2
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后把外接 SSD 挂上来看看原来的 <code>fstab</code> 怎么写：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mkdir -p {test,test1}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mount  /dev/sda1 ./test
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mount  ./test/backup-archlinux.squashfs ./test1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat ./test1/etc/fstab
</span></span></code></pre></td></tr></table>
</div>
</div><p>分区布局是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># /dev/nvme1n1p2</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>be72b201-80a6-4224-ba13-4bb6e0414577       /               btrfs           rw,relatime,compress<span class="o">=</span>zstd:3,ssd,discard<span class="o">=</span>async,space_cache<span class="o">=</span>v2,subvolid<span class="o">=</span>256,subvol<span class="o">=</span>/@      <span class="m">0</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/nvme1n1p2</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>be72b201-80a6-4224-ba13-4bb6e0414577       /tmp            btrfs           rw,relatime,compress<span class="o">=</span>zstd:3,ssd,discard<span class="o">=</span>async,space_cache<span class="o">=</span>v2,subvolid<span class="o">=</span>257,subvol<span class="o">=</span>/@tmp   <span class="m">0</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/nvme1n1p2</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>be72b201-80a6-4224-ba13-4bb6e0414577       /usr/local      btrfs           rw,relatime,compress<span class="o">=</span>zstd:3,ssd,discard<span class="o">=</span>async,space_cache<span class="o">=</span>v2,subvolid<span class="o">=</span>258,subvol<span class="o">=</span>/@usr_local     <span class="m">0</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/nvme1n1p2</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>be72b201-80a6-4224-ba13-4bb6e0414577       /var/log        btrfs           rw,relatime,compress<span class="o">=</span>zstd:3,ssd,discard<span class="o">=</span>async,space_cache<span class="o">=</span>v2,subvolid<span class="o">=</span>259,subvol<span class="o">=</span>/@var_log       <span class="m">0</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/nvme0n1p1 LABEL=SYSTEM</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>BE42-0216          /boot/efi       vfat            rw,relatime,fmask<span class="o">=</span>0022,dmask<span class="o">=</span>0022,codepage<span class="o">=</span>437,iocharset<span class="o">=</span>ascii,shortname<span class="o">=</span>mixed,utf8,errors<span class="o">=</span>remount-ro    <span class="m">0</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/nvme1n1p3</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>97ed42a1-e595-4009-81f0-470f9d183109       /home           ext4            rw,relatime     <span class="m">0</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># /dev/nvme1n1p2</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>be72b201-80a6-4224-ba13-4bb6e0414577       /.snapshots     btrfs           rw,relatime,compress<span class="o">=</span>zstd:3,ssd,discard<span class="o">=</span>async,space_cache<span class="o">=</span>v2,subvolid<span class="o">=</span>260,subvol<span class="o">=</span>/@snapshots     <span class="m">0</span> <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>那子卷布局还是按照原来的做：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 先把根挂上来,开启压缩（必须和打包前的分区inode保持一致）</span>
</span></span><span class="line"><span class="cl">mount -o <span class="nv">compress</span><span class="o">=</span>zstd /dev/nvme1n1p2 /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># 根分区</span>
</span></span><span class="line"><span class="cl">btrfs subvolume create /mnt/@
</span></span><span class="line"><span class="cl"><span class="c1"># /tmp</span>
</span></span><span class="line"><span class="cl">btrfs subvolume create /mnt/@tmp
</span></span><span class="line"><span class="cl"><span class="c1"># /var/log</span>
</span></span><span class="line"><span class="cl">btrfs subvolume create /mnt/@var_log
</span></span><span class="line"><span class="cl"><span class="c1"># /usr/local</span>
</span></span><span class="line"><span class="cl">btrfs subvolume create /mnt/@usr_local
</span></span><span class="line"><span class="cl"><span class="c1"># /.snapshots</span>
</span></span><span class="line"><span class="cl">btrfs subvolume create /mnt/@snapshots
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 卸载根分区</span>
</span></span><span class="line"><span class="cl">umount /mnt
</span></span></code></pre></td></tr></table>
</div>
</div><p>接着直接挂分区：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 根分区和子卷</span>
</span></span><span class="line"><span class="cl">mount -o <span class="nv">compress</span><span class="o">=</span>zstd,subvol<span class="o">=</span>@ /dev/nvme1n1p2 /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># 创建挂载点</span>
</span></span><span class="line"><span class="cl">mkdir -p /mnt/<span class="o">{</span>home.usr/local,proc.run,sys,media,dev,var/log,tmp,.snapshots,boot/efi<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 挂载其他子卷</span>
</span></span><span class="line"><span class="cl">mount -o <span class="nv">compress</span><span class="o">=</span>zstd,subvol<span class="o">=</span>@tmp /dev/nvme1n1p2 /mnt/tmp
</span></span><span class="line"><span class="cl">mount -o <span class="nv">compress</span><span class="o">=</span>zstd,subvol<span class="o">=</span>@var_log /dev/nvme1n1p2 /mnt/var/log
</span></span><span class="line"><span class="cl">mount -o <span class="nv">compress</span><span class="o">=</span>zstd,subvol<span class="o">=</span>@usr_local /dev/nvme1n1p2 /mnt/usr/local
</span></span><span class="line"><span class="cl">mount -o <span class="nv">compress</span><span class="o">=</span>zstd,subvol<span class="o">=</span>@snapshots /dev/nvme1n1p2 /mnt/.snapshots
</span></span><span class="line"><span class="cl"><span class="c1"># efi 和 home</span>
</span></span><span class="line"><span class="cl">mount /dev/nvme0n1p1 /mnt/boot/efi
</span></span><span class="line"><span class="cl">mount /dev/nvme1n1p3 /mnt/home
</span></span></code></pre></td></tr></table>
</div>
</div><p>释放镜像：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 取消挂载镜像</span>
</span></span><span class="line"><span class="cl">umount ./test1
</span></span><span class="line"><span class="cl"><span class="c1"># 释放镜像</span>
</span></span><span class="line"><span class="cl">unsquashfs -f -d /mnt test/backup-archlinux.squashfs
</span></span></code></pre></td></tr></table>
</div>
</div><p>完成后基本就没什么问题了，但是需要重新装一下 grub：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># chroot 到系统</span>
</span></span><span class="line"><span class="cl">arch-chroot /mnt
</span></span><span class="line"><span class="cl"><span class="c1"># 删除旧的 grub 引导</span>
</span></span><span class="line"><span class="cl">rm -rf /boot/efi/EFI/Debian
</span></span><span class="line"><span class="cl"><span class="c1"># 装载引导器</span>
</span></span><span class="line"><span class="cl">grub-install --target<span class="o">=</span>x86_64-efi --efi-directory<span class="o">=</span>/boot/efi/ --recheck
</span></span><span class="line"><span class="cl"><span class="c1"># 生成配置</span>
</span></span><span class="line"><span class="cl">grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于根分区 UUID 变了，因为 fstab 还是得改一下，直接退出  chroot 环境，执行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">genfstab -U /mnt &gt;&gt; /mnt/etc/fstab
</span></span></code></pre></td></tr></table>
</div>
</div><p>重启一下发现又回到和蔼可亲的 Arch Linux 了。</p>
<h2 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h2>
<p>先排除自己的菜的原因。我可能菜，但是桌面系统用的如此憋屈感觉应该不全是我的问题&hellip;每次想从 Arch 叛逃，但是又逃回来，每次都是走之前觉得 Arch 这不好那不好骗自己能有办法安心在新发行版下熟悉，但是用着用着却又想起之前的各个好处。尤其是有 aur 这样的整合的，统一的平台这件事。省去了很多麻烦，也方便统一管理。</p>
<p>但是话又说回来，现在的自己竟然这么习惯于逃避了&hellip;果然是因为害怕的事情变多了的缘故么。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.weearc.top/tags/archlinux/">archlinux</a></li>
      <li><a href="https://blog.weearc.top/tags/%E7%B3%BB%E7%BB%9F%E8%BF%81%E7%A7%BB/">系统迁移</a></li>
      <li><a href="https://blog.weearc.top/tags/debian/">debian</a></li>
      <li><a href="https://blog.weearc.top/tags/btrfs/">btrfs</a></li>
      <li><a href="https://blog.weearc.top/tags/%E7%B3%BB%E7%BB%9F%E5%A4%87%E4%BB%BD/">系统备份</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://blog.weearc.top/posts/2817549702/">
    <span class="title">下一页 »</span>
    <br>
    <span>记从 HEXO 迁移到 Hugo 安家之旅</span>
  </a>
</nav>

  </footer><script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<div id="vcomments"></div>
<script>
    function loadComments() {
        
        new Valine({
            el: '#vcomments',
            appId: 'bhQyg8BFhAianSbFIDztqY5F-gzGzoHsz',
            appKey: 'hyBnHdPlTNOtclNbq8oB5bwg',
            placeholder: 'Just so so',
            notify: 'true',
            verify: 'true',
            path: '\/posts\/2866972811\/',
            avatar: '',
            meta: '',
            pageSize: '',
            lang: '',
            visitor: '',
            highlight: '',
            avatarForce: '',
            recordIP: ''
        });
    }
    if (window.location.pathname !== '/about/' && window.location.pathname !== '/frlink/') {
        loadComments()
    }
</script>
</article>
        </div>
    </main>
    
<footer class="footer">
    <span>Copyright &copy; 2023 | <a href="https://blog.weearc.top">weearc 的个人博客</a></span></br>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> & theme based on
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span></br>
    <span>
        <a href="http://beian.miit.gov.cn/" rel="noopener" target="_blank" style="border:none;">
            辽ICP备2020011073号
        </a>
    </span>
    </br>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span>
    <span id="busuanzi_container_site_uv"> 本站访客数 <span id="busuanzi_value_site_uv"></span> 人次 </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>
<script type="text/javascript" src="/js/custom.js"></script>
</html>
